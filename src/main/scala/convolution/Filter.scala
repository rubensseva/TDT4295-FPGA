package morphinator

import chisel3._
import chisel3.util._

class Filter(val parallelPixels: Int) extends Module {

    val io = IO(
        new Bundle {
            // input fra SPI
            val SPI_filterIndex = Input(UInt(6.W))
            val SPI_invert      = Input(Bool())
            val SPI_distort     = Input(Bool())
            
            val pixelVal_out    = Output(Vec(parallelPixels, UInt(4.W)))
            val valid_out       = Output(Bool())
        }
    )

    val kernelSize = 3
    var imageWidth = 64
    var imageHeight = 48
    
    val colorInvert = RegInit(Bool(), false.B)
  
    val kernels = VecInit(
        VecInit( // Identity
            0.S(5.W), 0.S(5.W), 0.S(5.W),
            0.S(5.W), 1.S(5.W), 0.S(5.W),
            0.S(5.W), 0.S(5.W), 0.S(5.W)
        ),
        VecInit( // Box blur
            1.S(5.W), 1.S(5.W), 1.S(5.W),
            1.S(5.W), 1.S(5.W), 1.S(5.W),
            1.S(5.W), 1.S(5.W), 1.S(5.W)
        ),
        VecInit( // Gaussian blur
            1.S(5.W), 2.S(5.W), 1.S(5.W),
            2.S(5.W), 4.S(5.W), 2.S(5.W),
            1.S(5.W), 2.S(5.W), 1.S(5.W)
        ),
        VecInit( // Edge detector
            0.S(5.W), -1.S(5.W), 0.S(5.W),
            -1.S(5.W), 4.S(5.W), -1.S(5.W),
            0.S(5.W), -1.S(5.W), 0.S(5.W)
        ),
        VecInit( // Edge detector
            -1.S(5.W), -1.S(5.W), -1.S(5.W),
            -1.S(5.W), 8.S(5.W), -1.S(5.W),
            -1.S(5.W), -1.S(5.W), -1.S(5.W)
        ),
        VecInit( // Sharpening
            0.S(5.W), -1.S(5.W), 0.S(5.W),
            -1.S(5.W), 5.S(5.W), -1.S(5.W),
            0.S(5.W), -1.S(5.W), 0.S(5.W)
        )
    )
    val kernelSums = VecInit(
        RegInit(SInt(8.W), 1.S),
        RegInit(SInt(8.W), 9.S),
        RegInit(SInt(8.W), 16.S),
        RegInit(SInt(8.W), 1.S),
        RegInit(SInt(8.W), 1.S),
        RegInit(SInt(8.W), 1.S)
    )
  

    val image = RegInit(VecInit(Seq.fill(64 * 48)(0.U(4.W))))
    val imageData : List[Int] = List(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 2, 4, 4, 5, 5, 5, 5, 5, 5, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 3, 4, 4, 4, 4, 4, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 3, 0, 0, 1, 0, 3, 4, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 4, 4, 3, 0, 1, 4, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 4, 5, 5, 5, 5, 5, 3, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 1, 4, 6, 6, 6, 6, 6, 6, 6, 5, 4, 4, 4, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 5, 6, 6, 6, 6, 6, 6, 5, 5, 6, 6, 6, 6, 5, 4, 4, 4, 5, 5, 5, 4, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 2, 5, 6, 6, 6, 6, 6, 5, 4, 5, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 5, 4, 4, 4, 4, 4, 4, 2, 3, 4, 5, 6, 6, 6, 6, 6, 6, 5, 4, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 3, 1, 1, 0, 0, 0, 0,
0, 0, 0, 0, 0, 2, 5, 6, 6, 6, 6, 5, 4, 6, 6, 6, 6, 6, 6, 6, 5, 4, 4, 5, 6, 6, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 5, 4, 4, 6, 6, 4, 4, 6, 6, 5, 5, 8, 10, 11, 11, 11, 11, 10, 9, 8, 5, 5, 5, 3, 0, 0, 0, 0,
0, 0, 0, 0, 3, 5, 5, 6, 6, 6, 5, 5, 6, 6, 6, 6, 6, 6, 5, 4, 5, 6, 5, 6, 9, 11, 12, 13, 14, 14, 13, 13, 12, 11, 8, 5, 5, 6, 5, 3, 5, 6, 6, 5, 9, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 12, 9, 4, 3, 0, 0, 0,
0, 0, 0, 2, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 5, 6, 5, 9, 13, 14, 14, 14, 14, 14, 14, 14, 15, 15, 14, 14, 14, 14, 12, 8, 3, 5, 6, 6, 6, 13, 14, 14, 14, 15, 14, 15, 15, 14, 14, 14, 14, 12, 10, 11, 13, 14, 9, 2, 0, 0,
0, 0, 0, 4, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 5, 6, 6, 6, 13, 14, 14, 14, 15, 14, 15, 15, 14, 15, 15, 14, 13, 10, 7, 7, 9, 12, 13, 8, 5, 6, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 14, 11, 3, 0, 0, 0, 0, 7, 14, 12, 6, 0,
0, 0, 3, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 8, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 14, 9, 0, 0, 0, 0, 0, 0, 5, 13, 10, 9, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 11, 0, 0, 0, 0, 0, 0, 0, 6, 14, 11, 3,
0, 0, 4, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 7, 11, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 9, 0, 0, 0, 0, 0, 0, 0, 0, 5, 14, 9, 12, 14, 15, 15, 15, 15, 15, 15, 15, 14, 6, 5, 13, 5, 7, 12, 9, 0, 0, 13, 13, 8,
0, 2, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 7, 13, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 13, 1, 0, 12, 12, 0, 10, 13, 9, 0, 0, 11, 14, 7, 14, 15, 15, 15, 15, 15, 15, 15, 14, 5, 0, 4, 0, 12, 14, 13, 1, 0, 12, 14, 9,
1, 3, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 4, 11, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 13, 0, 0, 6, 6, 4, 14, 14, 14, 2, 0, 11, 14, 7, 14, 15, 15, 15, 15, 15, 15, 15, 14, 10, 0, 5, 7, 3, 8, 5, 0, 5, 14, 13, 8,
0, 4, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 5, 6, 8, 11, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 3, 0, 0, 6, 1, 9, 11, 8, 0, 0, 12, 14, 5, 13, 14, 14, 15, 15, 15, 15, 15, 15, 14, 9, 0, 0, 0, 0, 0, 5, 13, 14, 11, 3,
0, 4, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 6, 12, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 11, 1, 0, 9, 3, 0, 0, 0, 0, 8, 14, 12, 4, 5, 9, 14, 14, 14, 15, 15, 15, 15, 15, 14, 12, 10, 8, 9, 11, 14, 14, 11, 4, 2,
0, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 9, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 12, 5, 0, 0, 0, 0, 3, 10, 14, 13, 5, 6, 6, 6, 5, 9, 12, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 11, 6, 0, 0, 0,
1, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 6, 6, 6, 5, 11, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 14, 13, 11, 11, 12, 14, 14, 11, 4, 6, 6, 6, 6, 6, 6, 5, 5, 6, 8, 10, 11, 11, 11, 10, 9, 7, 5, 5, 6, 1, 0, 0,
2, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 5, 6, 6, 5, 6, 10, 13, 14, 14, 14, 15, 14, 14, 15, 14, 14, 14, 14, 13, 11, 6, 4, 5, 6, 6, 6, 6, 6, 6, 5, 5, 6, 6, 6, 6, 6, 6, 6, 7, 6, 5, 4, 2, 0, 0, 0,
3, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 5, 6, 6, 6, 5, 5, 8, 10, 11, 11, 12, 12, 11, 10, 8, 6, 4, 5, 6, 3, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 4, 4, 4, 4, 4, 3, 0, 0, 0, 0, 0, 0, 0,
3, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 4, 5, 6, 6, 6, 6, 6, 5, 5, 6, 6, 6, 6, 6, 5, 3, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 3, 1, 0, 0, 0, 0,
3, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 4, 4, 5, 4, 4, 4, 4, 4, 4, 4, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 1, 0, 0,
3, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 4, 0, 0,
3, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 4, 4, 5, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 4, 4, 4, 5, 4, 0, 0,
3, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 4, 4, 4, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 2, 0, 0,
3, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 4, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 6, 6, 6, 6, 3, 0, 0,
3, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 4, 5, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 4, 4, 4, 3, 4, 4, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 4, 5, 6, 6, 3, 0, 0, 0,
2, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 4, 5, 6, 6, 6, 6, 6, 6, 5, 4, 3, 3, 3, 3, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 4, 6, 5, 2, 0, 0, 0, 0,
1, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 3, 5, 6, 6, 6, 6, 6, 5, 4, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 3, 6, 6, 3, 0, 0, 0, 0, 0,
0, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 3, 5, 6, 6, 6, 5, 3, 2, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 5, 5, 6, 6, 0, 0, 0, 0, 0, 0,
0, 4, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 5, 6, 6, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 5, 5, 6, 6, 0, 0, 0, 0, 0, 0,
0, 4, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 6, 4, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 5, 5, 6, 6, 0, 0, 0, 0, 0, 0,
0, 3, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 6, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 5, 5, 6, 6, 0, 0, 0, 0, 0, 0,
0, 2, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 3, 6, 5, 2, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 5, 5, 6, 6, 1, 0, 0, 0, 0, 0,
0, 0, 4, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 6, 5, 3, 2, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 4, 6, 6, 1, 0, 0, 0, 0, 0,
0, 1, 3, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 6, 6, 6, 5, 3, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 4, 6, 6, 2, 0, 0, 0, 0, 0,
0, 0, 0, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 5, 6, 6, 6, 2, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 3, 6, 6, 2, 0, 0, 0, 0, 0,
0, 0, 0, 2, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 5, 6, 6, 5, 2, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 3, 6, 6, 2, 0, 0, 0, 0, 0,
0, 0, 0, 0, 3, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 5, 6, 6, 5, 3, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 6, 6, 2, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 4, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 6, 6, 6, 4, 3, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 6, 6, 2, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 4, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 6, 6, 6, 6, 4, 4, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 3, 6, 6, 2, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 4, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 4, 6, 6, 6, 6, 5, 4, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 6, 6, 6, 2, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 3, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 4, 6, 6, 6, 6, 5, 4, 4, 5, 5, 6, 6, 6, 6, 6, 6, 5, 5, 4, 4, 5, 6, 6, 6, 5, 1, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 4, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 4, 5, 6, 6, 6, 6, 6, 5, 5, 4, 4, 4, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 4, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 4, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 4, 2, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 3, 4, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 3, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 3, 4, 4, 4, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 4, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 3, 4, 4, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 5, 4, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 4, 4, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)

    for(i <- 0 until imageWidth * imageHeight){
        image(i) := imageData(i).U
    }

    val kernelConvolution = Module(new KernelConvolution(kernelSize, parallelPixels)).io
    
    val (kernelCounter, kernelCountReset)  = Counter(true.B, kernelSize * kernelSize)
    kernelConvolution.kernelVal_in := kernels(io.SPI_filterIndex)(kernelCounter)
    //printf("Kernelval: %d\n", kernels(io.SPI_filterIndex)(kernelCounter))
    
    val (imageCounterX, imageCounterXReset) = Counter(true.B, kernelSize)
    val (imageCounterY, imageCounterYReset) = Counter(imageCounterXReset, kernelSize)
    val pixelIndex = RegInit(UInt(32.W), 0.U)

    for (i <- 0 until parallelPixels){
        val x = (pixelIndex + i.U) / imageWidth.U + imageCounterX - 1.U
        val y = (pixelIndex + i.U) % imageWidth.U + imageCounterY - 1.U
        when(x < 0.U || x >= imageWidth.U || y < 0.U || y >= imageHeight.U){
            kernelConvolution.pixelVal_in(i) := 0.U
        }.otherwise{
            kernelConvolution.pixelVal_in(i) := image(y * imageWidth.U + x)
        }
    }

    for(i <- 0 until parallelPixels){
        val normVal = kernelSums(io.SPI_filterIndex)
        val pixOutRaw = kernelConvolution.pixelVal_out(i)
        /*when (pixOutRaw < 0.S) {  // normalize (clip hi/lo and scale rest)
          // val pixOut = (~pixOutRaw + 1.S).asUInt // abs
          val pixOut = 0.U 
        } .elsewhen(pixOutRaw > 15.S) {
          val pixOut = 15.U 
        } .otherwise {
          val pixOut = 
        }*/
        when(colorInvert){
            io.pixelVal_out(i) := 15.U - (pixOutRaw / normVal).asUInt 
        }.otherwise{
            io.pixelVal_out(i) := (pixOutRaw / normVal).asUInt
        }
    }
    
    io.valid_out := kernelConvolution.valid_out 
    
    when(kernelCountReset){
        pixelIndex := pixelIndex + parallelPixels.U
        when(pixelIndex === imageWidth.U * imageHeight.U){
            pixelIndex := 0.U
        }
    }
}
